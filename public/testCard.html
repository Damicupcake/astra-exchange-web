<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/aes.js"></script>
    <script type="text/javascript" src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">
    <link rel="shortcut icon" href="https://i.imgur.com/ufHYGd9.png">
    <script defer src="/__/firebase/5.7.3/firebase-app.js"></script>
    <script defer src="/__/firebase/5.7.3/firebase-auth.js"></script>
    <script defer src="/__/firebase/5.7.3/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.7.3/firebase.js"></script>
    <script defer src="/__/firebase/init.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Nunito:600,700" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>
    <title>Test QR Codes</title>
    <style>
      * {
        font-family: Nunito;
      }
    </style>
  </head>
  <body>
    <h1 id="nameOfUser"></h1>
    <h1 id="wealthOfUser"></h1>
    <video autoplay="autoplay" class="active" id="preview"></video>
    <script>
      let scanner = new Instascan.Scanner({ video: document.getElementById('preview') })

      let config = {
        apiKey: "AIzaSyDOfmd3fntDblft3mhjccRiEggWu_t5fW0",
        authDomain: "astra-exchange.firebaseapp.com",
        databaseURL: "https://astra-exchange.firebaseio.com",
        projectId: "astra-exchange",
        storageBucket: "astra-exchange.appspot.com",
        messagingSenderId: "946665066699"
      }
      firebase.initializeApp(config)
      let defaultDatabase = firebase.database()

      Instascan.Camera.getCameras().then(function (cameras) {
        if (cameras.length > 0) {
          scanner.start(cameras[0])
          document.getElementById("preview").style.background = ""
          currentSetting = 1
          document.getElementById("title").innerHTML = name
          openSellingMenuDisplays()
        } else {
          alert("No cameras found!")
        }
      }).catch(function (e) {
        alert("Error!")
      })

      scanner.addListener('scan', function (content) {
        const cardId = CryptoJS.AES.decrypt(content, "1r80823f8u2380r0h82f0hdobufhaw-qji2edjqwidnbq39r02qbf").toString(CryptoJS.enc.Utf8)
        return firebase.database().ref('cards/' + cardId).once('value').then(function(snapshot) {
          const customerId = snapshot.val()

          if (customerId) {
            return firebase.database().ref('users/' + customerId).once('value').then(function(snapshot) {
              document.getElementById("nameOfUser").innerHTML = snapshot.val().name
              document.getElementById("wealthOfUser").innerHTML = snapshot.val().balance
            })
          } else {
            alert("This card's id does not exist in the database! Please alert Kai he fudged up!")
          }
        })
      })
    </script>
  </body>
</html>
