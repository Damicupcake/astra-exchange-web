<!DOCTYPE html>
<html>
<head>
	<script src="https://code.jquery.com/jquery-3.3.1.js"></script>
	<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">
	<link rel="shortcut icon" href="https://i.imgur.com/ufHYGd9.png">
	<script defer src="/__/firebase/5.7.3/firebase-app.js"></script>
	<script defer src="/__/firebase/5.7.3/firebase-auth.js"></script>
	<script defer src="/__/firebase/5.7.3/firebase-database.js"></script>
	<script src="https://www.gstatic.com/firebasejs/5.7.3/firebase.js"></script>
	<script defer src="/__/firebase/init.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
	<link href="https://fonts.googleapis.com/css?family=Nunito:600,700" rel="stylesheet">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>
	<title>Astra Exchange</title>
	<style>
	*,h1,h2 {
		font-family: Nunito;
		text-align: center;
		color: rgba(0, 0, 0, 0.8);
	}
	body {
		overflow: scroll;
	}
	button {
		width: 280px;
		margin-top: 30px;
		margin-bottom: 13px;
		background: lightgray;
	}
	#exchangeBox {
		height: 320px;
		width: 500px;
		margin: auto;
		margin-top: 30px;
	}
	#title {
		margin-top: 15px;
		font-size: 50px;
	}
	#astrasToExchange {
		text-align: center;
		width: 300px;
		margin: auto;
		margin-top: 30px;
	}
	#deHeader {
		margin-top: 10px;
		margin-bottom: 20px;
	}
	#userDisplay, #wealthDisplay, #wealthLabel, #independence {
		font-size: 35px;
		font-weight: 700;
	}
	#wealthLabel, #wealthDisplay, #independence {
		margin-top: 10px;
		margin-right: 5px;
	}
	#userDisplay {
		margin-top: 10px;
	}
	#receiver {
		margin-top: -20px;
		width: 300px;
	}
	img {
		margin: auto;
	}
	.flexContainer {
		display: flex;
		justify-content: center;
	}
	#headerBox {
		height: 150px;
	}
	#logo {
		margin-top: 20px;
		width: 135px;
	}
	#copyright {
		text-align: right;
		vertical-align: bottom;
		margin-right: 20px;
		font: Nunito;
	}
	#exchangeHistBox {
		height: 350px;
		width: 650px;
		border-style: solid;
		border-color: lightgray;
		margin-right: 80px;
		overflow: scroll;
	}
	#mainContainer {
		display: flex;
		justify-content: space-around;
	}
	#ehbLabel {
		margin-top: -400px;
		margin-left: 740px;
		border-style: solid;
		border-color: lightgray;
		width: 400px;
	}
	::-webkit-scrollbar {
		width: 10px;
	}
	::-webkit-scrollbar-track {
		background: #f1f1f1;
	}
	::-webkit-scrollbar-thumb {
		background: #888;
	}
	::-webkit-scrollbar-thumb:hover {
		background: #555;
	}
	#noteInput {
		width: 300px;
		margin: auto;
		margin-top: 30px;
	}
	#mainPage {
		display: flex;
		justify-content: space-around;
	}
	#ceModalLabel {
		font-size: 40px;
	}
	#modalContainer {
		position: absolute;
		top: 24vw;
		left: 50%;
		width: 700px;
		transform: translate(-50%, -50%);
	}
	#closeButton {
		margin-top: 5px;
		height: 40px;
		margin-bottom: 5px;
	}
	#vtButton, #ivButton {
		margin-top: 10px;
		width: 250px;
		display: block;
		text-align: center;
		margin: 0 auto;
	}
	.menuIcon {
		width: 75px;
		margin-left: 2px;
		margin-right: 2px;
		transition: outline-color 0.2s ease-out;
		outline-color: rgba(0, 0, 250, 0);
	}
	.menuIcon:hover {
		outline: solid;
		outline-color: rgba(0, 0, 250, 0.1);
	}
	#iconBar {
		margin-top: -51px;
		margin-left: 310px;
	}
	#savePinButton {
		margin-top: 20px;
	}
	#soButton {
		margin-top: 20px;
		width: 250px;
	}
	#exitIcon {
		height: 40px;
		width: 42px;
		margin-top: 10px;
		margin-left: 5px;
	}
	#wealthContainer {
		width: 100%;
	}
	#independenceDisplay {
		margin-top: -30px;
	}
	#debitCardConfigure {
		margin-right: 149px;
		margin-left: 4px;
	}
	#ivButton {
		margin-top: 10px;
	}
	#invModalMain {
		display: flex;
	}
	#invoiceModalContainer {
		width: 800px;
		margin-left: -150px;
	}
	#invoiceHistBox {
		margin-right: 20px;
		padding-left: 20px;
	}
	#invMessageInput, #invAstrasInvolvedInput {
		margin-top: 10px;
	}
	.invoiceButton {
		width: 80px;
		height: 40px;
		line-height: 10px;
		margin-top: 0px;
		vertical-align: middle;
	}
	#invoiceCreationBox {
		border-left-style: solid;
		border-left-color: lightgray;
		padding-left: 10px;
	}
	#leaderboardIcon {
		width: 77px;
		margin-left: 4px;
		margin-bottom: 1px;
	}
	</style>
</head>
<body>
	<div id="headerBox" class="flexContainer">
		<img id="logo" src="https://i.imgur.com/ufHYGd9.png"/>
	</div>
	<div id="iconBar">
	<!-- The code for invoices is just about complete, but I don't think they're a good feature, and thus I'm commenting this out! <img id="invoiceIcon" class="menuIcon" onclick="openInVoiceInterface()" src="https://i.imgur.com/sdl2GDF.png" />-->
	<img id="debitCardConfigure" class="menuIcon" onclick="showPin()" src="https://i.imgur.com/XNRzL8b.png" />
	<img id="companyInterface" onclick="window.location.href='company.html'" class="menuIcon" src="https://i.imgur.com/ElJDPc5.png">
	<img id="graphWorksIcon" onclick="window.location.href='investData.html?comp=index'" class="menuIcon" src="https://i.imgur.com/HI4zOkz.png">
	<a href="bazaarTableManagement.html"><img id="btmIcon" class="menuIcon" src="https://i.imgur.com/F3TNjOs.png"></a>
	<img id="leaderboardIcon" onclick="openLeaderboard()" class="menuIcon" src="https://i.imgur.com/yhrOBSJ.png">
	<img id="exitIcon" class="menuIcon" src="https://i.imgur.com/N5tesXB.png" onclick="signOutUser()">
	</div>
	<h1 id="title">Astra Exchange Network</h1>
	<div class="flexContainer">
	<img id="profileImage"/>
	</div>
	<div id="mainPage">
	<div id="mainUserInterface">
		<h2 id="userDisplay"></h1>
		<h7 id="independenceDisplay"></h7>
		<div class="flexContainer">
			<h2 id="wealthLabel"><h2 id="wealthDisplay"></h2></h2>
		</div>
		<div id="mainContainer" class="flexContainer">
		<div id="exchangeBox">
			<select class="custom-select mr-sm-2" id="receiver">
			<option value="nullSelected" selected disabled>Recipient</option>
			</select>
			<input id="astrasToExchange" class="form-control" placeholder="Amount" type="number"/>
			<input id="noteInput" class="form-control" placeholder="Message"/>
			<button class="btn btn-primary" onclick="makeDirectExchange()">Make Exchange</button>
			<button class="btn btn-secondary" onclick="viewTransactions()" id="vtButton">View Transaction History</button>
		</div>
		</div>
	</div>
</div>
	<div class="modal fade" id="transactionHistory" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
	<div class="modal-dialog" role="document">
		<div class="modal-content" id="modalContainer">
		<div class="modal-header">
			<h5 class="modal-title" id="ceModalLabel">Exchange History</h5>
		</div>
		<div class="modal-body" id="transModalMain">
			<div id="exchangeHistBox">
			</div>
		</div>
		<div class="modal-footer">
			<button type="button" class="btn btn-secondary" data-dismiss="modal" id="closeButton">Close</button>
		</div>
		</div>
	</div>
	</div>
</div>
<div class="modal fade" id="debitCardSettings" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
	<div class="modal-dialog" role="document">
		<div class="modal-content" id="modalContainer">
		<div class="modal-header">
			<h5 class="modal-title" id="ceModalLabel">Debit Card Configuration</h5>
		</div>
		<div class="modal-body" id="transModalMain">
			<h2 id="currentPin">Current PIN: </h2>
			<input id="pinInput" class="form-control" type="number" placeholder="Change PIN"/>
			<button class="btn btn-primary" id="savePinButton" onclick="savePin()">Save</button>
		</div>
		<div class="modal-footer">
			<button type="button" class="btn btn-secondary" data-dismiss="modal" id="closeButton">Close</button>
		</div>
		</div>
	</div>
</div>
<div class="modal fade" id="invoiceInterface" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
	<div class="modal-dialog" role="document">
		<div class="modal-content" id="invoiceModalContainer">
			<div class="modal-header">
				<h3 class="modal-title" id="invModalLabel">Invoice Interface</h3>
			</div>
			<div class="modal-body" id="invModalMain">
				<div id="invoiceHistBox">
					<h4>You haven't made or received any invoices yet!</h4>
				</div>
				<table class="table" id="invoiceHistTable">
				</table>
				<div id="invoiceCreationBox">
					<select class="custom-select mr-sm-2" id="invReceiver">
						<option value="nullSelected" selected disabled>Receiver</option>
					</select>
					<input id="invAstrasInvolvedInput" type="number" class="form-control" placeholder="Astras"/>
					<input id="invMessageInput" type="text" class="form-control" placeholder="Message"/>
					<button class="btn btn-primary" onclick="createInvoice()">Create Invoice</button>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal" id="closeButton">Close</button>
			</div>
		</div>
	</div>
</div>
<div class="modal fade" id="leaderboardModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
	<div class="modal-dialog" role="document">
		<div class="modal-content" id="leaderboardModalContainer">
			<div class="modal-header">
				<h3 class="modal-title" id="invModalLabel">Astra Exchange Leaderboard</h3>
			</div>
			<div class="modal-body" id="invModalMain">
				<table class="table">
					<thead>
						<tr>
							<th>Rank</th>
							<th>Name</th>
							<th>Wealth</th>
						</tr>
					</thead>
					<tbody id="studentList">
					</tbody>
				</table>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal" id="closeButton">Close</button>
			</div>
		</div>
	</div>
</div>
	<script>
	let id = document.cookie
	let name
	let email
	let userBalance
	let user = []
	let independenceLevel;
	let recievedBalance = false
	let change
	let userExist = true
	let transHistItems=[]
	let cards;
	let bazaarTableOrders;
	let tablesReserved;
	let config = {
		apiKey: "AIzaSyDOfmd3fntDblft3mhjccRiEggWu_t5fW0",
		authDomain: "astra-exchange.firebaseapp.com",
		databaseURL: "https://astra-exchange.firebaseio.com",
		projectId: "astra-exchange",
		storageBucket: "astra-exchange.appspot.com",
		messagingSenderId: "946665066699"
	};
	firebase.initializeApp(config)
	let database = firebase.database()
	function signOutUser() {
		firebase.auth().signOut().then(function() {
		  console.log('Signed Out');
			window.location.href = "index.html";
		}, function(error) {
		  console.error('Sign Out Error', error);
		});
	}
	function loadTransHist() {
		database.ref('transactions/'+id).on('child_added', function(snapshot) {
			const receiverId = snapshot.val().to
			const payerId = snapshot.val().from
			const astrasInvolved = snapshot.val().amount
			const dateOfTrans = snapshot.val().time
			const transNote = snapshot.val().message
			const newTrans = document.createElement("h4")
			let transNoteAddOn = ""
			if (transNote) {
				transNoteAddOn = " [ "+transNote+" ]"
			}
			return database.ref('users/' + receiverId + '/name').once('value').then(function(snapshot) {
				const receiverName = snapshot.val()
				return database.ref('users/' + payerId + '/name').once('value').then(function(snapshot) {
					const payerName = snapshot.val()
					newTrans.innerHTML = astrasInvolved+"A : "+payerName+" -> "+receiverName + " | "+dateOfTrans + transNoteAddOn
					newTrans.style.borderStyle = "solid"
					newTrans.style.borderColor = "lightgray"
					document.getElementById("exchangeHistBox").appendChild(newTrans)
				})
			})
		})
	}
	function showPin() {
		$("#debitCardSettings").modal("show")
		return firebase.database().ref('users/' + id + "/cards").once('value').then(function(snapshot) {
			const firstCardId = Object.keys(snapshot.val())[0]

			const pinNum = snapshot.val()[firstCardId].pin;
			document.getElementById("currentPin").innerHTML = "PIN: "+pinNum
		})
	}
	function savePin() {
		const newPin = document.getElementById("pinInput").value
		return firebase.database().ref('users/' + id + "/cards").once('value').then(function(snapshot) {
			const firstCardId = Object.keys(snapshot.val())[0]
			console.log(firstCardId)
			firebase.database().ref("users/" + id + "/cards/" + firstCardId).update({
				pin: newPin
			}).then(function() {
				document.getElementById("pinInput").value = ""
				$("#debitCardSettings").modal("hide")
			})
		})
	}
	function loadUserData() {
		database.ref('users/' + id).on('value', function(snapshot) {
			if (isTeacher()) {
				document.getElementById("astrasToExchange").type = "text"
			}
			cards = snapshot.val().cards;
			bazaarTableOrders = snapshot.val().bazaarTableOrders;

			name = snapshot.val().name
			change = !(userBalance > snapshot.val().balance)
			const neutralChange = userBalance == snapshot.val().balance;
			userBalance = snapshot.val().balance
			email = snapshot.val().email
			const i = snapshot.val().independence
			independenceLevel = i == 0 ? 'Pending' : i
			tablesReserved = snapshot.val().tablesReserved
			document.getElementById("userDisplay").innerHTML = name
			document.getElementById("wealthLabel").innerHTML = "Wealth: "
			document.getElementById("wealthDisplay").innerHTML = userBalance + "A"
			document.getElementById("independenceDisplay").innerHTML = "<i>Independence Level: "+independenceLevel + "</i>"
			if (recievedBalance && change && !neutralChange) {
					$( "#wealthDisplay" ).animate({
					color: "#98FB98"
					}, 200)
					$( "#wealthDisplay" ).animate({
					color: "rgba(0, 0, 0, 0.8)"
					}, 700)
			} else {
					if (recievedBalance && !neutralChange) {
						$("#wealthDisplay").animate({
							color: "#ff6961"
						}, 200)
						$("#wealthDisplay").animate({
							color: "rgba(0, 0, 0, 0.8)"
						}, 700)
					}
			}
			recievedBalance = true
		})
	}
	function loadReceiverData() {
		console.log("Loading receivers...")
		database.ref('users').on('child_added', function(snapshot) {
			receiverName = snapshot.val().name
			receiverId = snapshot.key
			console.log(receiverName)
			if (receiverId != id) {
				let newReceiverOption = document.createElement("option")
				newReceiverOption.value = receiverId
				newReceiverOption.innerHTML = receiverName

				const invReceiverOption = newReceiverOption.cloneNode(true);
				document.getElementById("receiver").appendChild(newReceiverOption)
				document.getElementById("invReceiver").appendChild(invReceiverOption);
			}
		})
	}
	function openInVoiceInterface() {
		$("#invoiceInterface").modal("show");
	}
	function isTeacher() {
		return id === 'h621pgey1vPfxrmoW5LUkZaHkhT2'
	}

	function getDate() {
		const dateList = Date().split(" ")
		let timeOfDay = " AM"
		const dateTime = (dateList[4].split(":")[0] % 12)+":"+dateList[4].split(":")[1]
		if (dateList[4].split(":")[0] > 11) {
		timeOfDay = " PM"
		}
		return dateList[1]+" "+dateList[2]+", "+dateList[3]+" @ "+dateTime+timeOfDay
	}
	function makeDirectExchange() {
		const astrasToExchange = document.getElementById("astrasToExchange").value
		if (astrasToExchange.match(/i\d/) && isTeacher()) {
			database.ref('transactions/' + id).push({
				time: getDate(),
				from: id,
				to: document.getElementById("receiver").value,
				amount: astrasToExchange,
				balance: userBalance,
				message: ''
			}).then(resetInputs)
		} else {
			const amount = Number(astrasToExchange)
			if (userBalance < amount) {
				alert("You have insufficient wealth to complete this transaction!");
			} else if (amount > 0 || isTeacher()) {
				database.ref('transactions/' + id).push({
					time: getDate(),
					from: id,
					to: document.getElementById("receiver").value,
					amount: amount,
					balance: userBalance - amount,
					message: document.getElementById("noteInput").value
				}).then(resetInputs)
			} else {
				alert("You can't transact negative (or non-existent) astras, you fool!");
			}
		}
	}

	function resetInputs() {
		document.getElementById("receiver").selectedIndex = 0
		document.getElementById("astrasToExchange").value = ""
		document.getElementById("noteInput").value = ""
	}
	function loginUser() {
		email = document.getElementById("emailInput").value
		const passwordInput = document.getElementById("passwordInput").value
		firebase.auth().signInWithEmailAndPassword(email, passwordInput).catch(function(error) {
			var errorCode = error.code
			var errorMessage = error.message

			firebase.auth().createUserWithEmailAndPassword(email, passwordInput).catch(function(error) {
				var errorCode = error.code
				var errorMessage = error.message
			})
			userExist=false
		})
	}
	function viewTransactions() {
		$("#transactionHistory").modal("show")
	}
	function findDecPoints(num) {
		if (num.includes(".")) {
		return num.split(".")[1].length
		} else {
		return 0
		}
	}
	function openLeaderboard() {
		$("#leaderboardModal").modal("show");
	}
	function acceptInvoice(invoiceId) {
		return firebase.database().ref("invoices/" + id + "/" + invoiceId).once('value').then(function(snapshot) {
			const astrasInvolved = snapshot.val().amount;
			const receiverId = snapshot.val().to;
			const invoiceNote = snapshot.val().message;

			database.ref('transactions/' + id).push({
				time: getDate(),
				from: id,
				to: receiverId,
				amount: astrasInvolved,
				balance: userBalance - astrasInvolved,
				message: invoiceNote
			}).then(function() {
				return firebase.database().ref("invoices/" + id + "/" + invoiceId).update({
					status: "accepted"
				}).then(function() {
					return firebase.database().ref("invoices/" + invoiceReceiver + "/" + invoiceId).update({
						status: "accepted"
					}).then(function() {
						alert("Invoice successfully accepted!");
					});
				})
			});
		});
	}
	function denyInvoice(invoiceId) {
		return firebase.database().ref("invoices/" + id + "/" + invoiceId).once('value').then(function(snapshot) {
			const astrasInvolved = snapshot.val().amount;
			const invoiceReceiver = snapshot.val().from;

			const confirmInvoiceDeny = confirm("Are you sure that you would like to deny this invoice?");
			if (confirmInvoiceDeny) {
				return firebase.database().ref("invoices/" + id + "/" + invoiceId).update({
					status: "denied"
				}).then(function() {
					return firebase.database().ref("invoices/" + invoiceReceiver + "/" + invoiceId).update({
						status: "denied"
					}).then(function() {
						alert("Invoice successfully denied!");
					});
				})
			} else {
				alert("Invoice deny request cancelled!");
			}
		});
	}
	function loadInvHist() {
		let cleared = false;
		database.ref('invoices/'+id).on('child_added', function(snapshot) {
			if (!cleared) {
				document.getElementById("invoiceHistBox").innerHTML = ""
				cleared = true
			}
			const receiverId = snapshot.val().to
			const payerId = snapshot.val().from
			const astrasInvolved = snapshot.val().amount
			const dateOfInv = snapshot.val().time
			const invNote = snapshot.val().message
			let newInv = document.createElement("tr")
			let transInvAddOn = ""
			if (invNote) {
				transNoteAddOn = " [ "+invNote+" ]"
			}
			return database.ref('users/' + receiverId + '/name').once('value').then(function(receiverSnapshot) {
				const receiverName = receiverSnapshot.val()
				return database.ref('users/' + payerId + '/name').once('value').then(function(payerSnapshot) {
					const payerName = payerSnapshot.val();
					const textHolder = document.createElement("td");
					const invData = document.createElement("h4");
					const buttonHolderOne = document.createElement("td");
					const buttonHolderTwo = document.createElement("td");
					const acceptButton = document.createElement("button");
					const denyButton = document.createElement("button");

					buttonHolderOne.appendChild(acceptButton);
					buttonHolderTwo.appendChild(denyButton);
					acceptButton.style.background = "lightgreen";
					denyButton.style.background = "lightred";
					acceptButton.innerHTML = "Accept";
					denyButton.innerHTML = "Deny";
					denyButton.className = "invoiceButton btn btn-danger";
					acceptButton.className = "invoiceButton btn btn-success";
					acceptButton.id = snapshot.key;
					denyButton.id = snapshot.key;
					acceptButton.onclick = function() { acceptInvoice(this.id) };
					denyButton.onclick = function() { denyInvoice(this.id) };
					invData.innerHTML = astrasInvolved + "A -> " + receiverName + transInvAddOn;
					invData.style.borderStyle = "solid";
					invData.style.borderColor = "lightgray";
					textHolder.appendChild(invData);
					newInv.appendChild(textHolder);
					newInv.appendChild(buttonHolderOne);
					newInv.appendChild(buttonHolderTwo);

					document.getElementById("invoiceHistTable").appendChild(newInv);
				})
			})
		})
	}
	function createInvoice() {
		const receiverOfInv = document.getElementById("invReceiver").value;
		const astrasInvolved = Number(document.getElementById("invAstrasInvolvedInput").value);
		const messageOfInv = document.getElementById("invMessageInput").value;

		return database.ref('users/' + receiverOfInv + '/balance').once('value').then(function(snapshot) {
			const receiverBalance = snapshot.val();

			if (astrasInvolved > 0) {
				let confirmMessage;
				if (astrasInvolved == receiverBalance) {
					confirmMessage = "Your invoice's Astras is equivalent to this user's wealth! Are you sure you would like to make this invoice?";
				} else if (astrasInvolved > receiverBalance) {
					confirmMessage = "Your invoice's Astras in greater than this user's wealth! Are you sure you would like to make this invoice?";
				}

				let invConfirm;
				if (confirmMessage) {
					invConfirm = confirm(confirmMessage);
				} else {
					invConfirm = true;
				}
				if (invConfirm) {
					database.ref('invoices/' + id).push({
						time: getDate(),
						from: id,
						to: receiverOfInv,
						amount: astrasInvolved,
						message: messageOfInv,
						status: "pending"
					}).then(function() {
						alert("Invoice created successfully!");
						document.getElementById("invMessageInput").value = "";
						document.getElementById("invAstrasInvolvedInput").value = "";
						document.getElementById("invReceiver").selectedIndex = 0;
					})
				} else {
					alert("Invoice cancelled!");
				}
			} else {
				alert("You can't send invoices with negative or zero Astras, you fool!");
			}
		});
	}
	function loadLeaderboardData() {
		return firebase.database().ref('users').on('value', function(snapshot) {
			document.getElementById("studentList").innerHTML = "";
			const userData = snapshot.val();
			let wealthToUserData = {};
			let userWealthArray = [];

			for (target of Object.keys(userData)) {
				const currentUserItem = userData[target];
				wealthToUserData[Number(currentUserItem.balance)] = currentUserItem.name;
			}

			for (target of Object.keys(wealthToUserData)) {
				userWealthArray.push(Number(target));
			}
			userWealthArray = userWealthArray.sort(function(a,b){return a - b}).reverse();

			//document.getElementById("wealthiestStudentOne").innerHTML = wealthToUserData[userWealthArray[0]] + " : " + userWealthArray[0] + "A";
			//document.getElementById("wealthiestStudentTwo").innerHTML = wealthToUserData[userWealthArray[1]] + " : " + userWealthArray[1] + "A";
			//document.getElementById("wealthiestStudentThree").innerHTML = wealthToUserData[userWealthArray[2]] + " : " + userWealthArray[2] + "A";

			for (let i=0;i<userWealthArray.length;i++) {
				let newStudentRow = document.createElement("tr");
				let studentIndex = document.createElement("td");
				let newStudentName = document.createElement("td");
				let newStudentWealth = document.createElement("td")
				newStudentName.innerHTML = wealthToUserData[userWealthArray[i]];
				newStudentWealth.innerHTML = userWealthArray[i]+"A";
				studentIndex.innerHTML = i+1;

				newStudentRow.appendChild(studentIndex);
				newStudentRow.appendChild(newStudentName);
				newStudentRow.appendChild(newStudentWealth);
				document.getElementById("studentList").appendChild(newStudentRow);
			}
		});
	}
	loadLeaderboardData();
	loadInvHist()
	loadTransHist()
	loadUserData()
	loadReceiverData()
	</script>
</body>
</html>
